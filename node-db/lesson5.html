
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Week 16 Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-prism/prism-tomorrow.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    
    <link rel="prev" href="lesson4.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../lesson0.html">
            
                <a href="../lesson0.html">
            
                    
                    Week 0
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" >
            
                <span>
            
                    
                    HTML/CSS
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../html-css/lesson1.html">
            
                <a href="../html-css/lesson1.html">
            
                    
                    Week 1 - Semantic HTML and CSS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../html-css/lesson2.html">
            
                <a href="../html-css/lesson2.html">
            
                    
                    Week 2 - Responsive Web and layout
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="../html-css/lesson3.html">
            
                <a href="../html-css/lesson3.html">
            
                    
                    Week 3 - Frameworks
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="../html-css/coding-101.html">
            
                <a href="../html-css/coding-101.html">
            
                    
                    Coding 101
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" >
            
                <span>
            
                    
                    JavaScript Core
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../js-core/lesson1.html">
            
                <a href="../js-core/lesson1.html">
            
                    
                    Week 4 - Hello JavaScript
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../js-core/lesson2.html">
            
                <a href="../js-core/lesson2.html">
            
                    
                    Week 5 - Arrays and Objects
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="../js-core/lesson3.html">
            
                <a href="../js-core/lesson3.html">
            
                    
                    Week 6 - Unit Testing and TDD
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="../js-core/lesson3.5.html">
            
                <a href="../js-core/lesson3.5.html">
            
                    
                    Week 7 - Pair Programming Day
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" >
            
                <span>
            
                    
                    JavaScript Core II
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="../js-core-2/lesson4.html">
            
                <a href="../js-core-2/lesson4.html">
            
                    
                    Week 8 - JS in the Browser
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="../js-core-2/lesson5.html">
            
                <a href="../js-core-2/lesson5.html">
            
                    
                    Week 9 - Good design and OO
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="../js-core-2/lesson6.html">
            
                <a href="../js-core-2/lesson6.html">
            
                    
                    Week 10 - More Arrays and ES6
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4" data-path="../js-core-2/lesson7.html">
            
                <a href="../js-core-2/lesson7.html">
            
                    
                    Week 11 - More Objects and core JS
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" >
            
                <span>
            
                    
                    Node and DB
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="lesson1.html">
            
                <a href="lesson1.html">
            
                    
                    Week 12 - Node and Express 101
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="lesson2.html">
            
                <a href="lesson2.html">
            
                    
                    Week 13 - Templating and APIs 
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="lesson3.html">
            
                <a href="lesson3.html">
            
                    
                    Week 14 - More Node, Middleware and Dynamo
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.4" data-path="lesson4.html">
            
                <a href="lesson4.html">
            
                    
                    Week 15 - MongoDB
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.6.5" data-path="lesson5.html">
            
                <a href="lesson5.html">
            
                    
                    Week 16
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.6" >
            
                <span>
            
                    
                    Week 17
            
                </span>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" >
            
                <span>
            
                    
                    React
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="../react/lesson1.html">
            
                <a href="../react/lesson1.html">
            
                    
                    Week 18
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="../react/lesson2.html">
            
                <a href="../react/lesson2.html">
            
                    
                    Week 19
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3" data-path="../react/lesson3.html">
            
                <a href="../react/lesson3.html">
            
                    
                    Week 20
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.4" data-path="../react/lesson4.html">
            
                <a href="../react/lesson4.html">
            
                    
                    Week 21
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="../house-rules.html">
            
                <a href="../house-rules.html">
            
                    
                    House Rules
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="../PRACTICES.html">
            
                <a href="../PRACTICES.html">
            
                    
                    Coding Standards and Best Practices
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="../CONTRIBUTING.html">
            
                <a href="../CONTRIBUTING.html">
            
                    
                    Contributing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11" data-path="../lesson-template.html">
            
                <a href="../lesson-template.html">
            
                    
                    Lesson Template
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Week 16</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <p><img src="https://img.shields.io/badge/status-draft-darkred.svg" alt=""></p>
<h1 id="node-5">Node 5</h1>
<p><strong>What will we learn today?</strong></p>
<ul>
<li>Mongoose</li>
<li>Modelling Data</li>
<li>Saving Data with HTML forms<ul>
<li>A note on Progressive Enhancement</li>
</ul>
</li>
<li>Modelling Relationships</li>
<li>Debugging NodeJS</li>
</ul>
<hr>
<h1 id="mongoose">Mongoose</h1>
<p>Mongoose is a library that allow you to model your application data using a <strong>schema</strong>. It uses type casting, validation, query building, business logic hooks and more to help you manage your data.</p>
<h2 id="what-is-a-schema">What is a Schema?</h2>
<p>A &quot;schema&quot; is like a blueprint for your data. In a Relational Database, it will define what tables exist in the database, what columns they contain, and what type of data, like numbers or strings, each column can accept.</p>
<p>Databases like MongoDB are said to be <strong>schema-less</strong>. If we have a collection called <em>persons</em>, a document may look like this:</p>
<pre class="language-"><code class="lang-js"><span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token string">&quot;Anthony&quot;</span><span class="token punctuation">,</span>
    age<span class="token punctuation">:</span> <span class="token number">21</span><span class="token punctuation">,</span>
    nationality<span class="token punctuation">:</span> <span class="token string">&quot;Kenya&quot;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>We can add a document to the <em>personss</em> collection with a new field: <em>profession</em>. Now we have two documents like this:</p>
<pre class="language-"><code class="lang-js"><span class="token punctuation">[</span><span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token string">&quot;Anthony&quot;</span><span class="token punctuation">,</span>
    age<span class="token punctuation">:</span> <span class="token number">21</span><span class="token punctuation">,</span>
    nationality<span class="token punctuation">:</span> <span class="token string">&quot;Kenya&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token string">&quot;Simon&quot;</span><span class="token punctuation">,</span>
    age<span class="token punctuation">:</span> <span class="token number">23</span><span class="token punctuation">,</span>
    nationality<span class="token punctuation">:</span> <span class="token string">&quot;South Africa&quot;</span><span class="token punctuation">,</span>
    profession<span class="token punctuation">:</span> <span class="token string">&quot;Software Engineer&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span>
</code></pre>
<p>One document has the field <em>profession</em> while the other does not. When we write our app to read the database, it will need to check if the <em>profession</em> field exists on a document before trying to use it.</p>
<p>In a Relational Database Management System (RDBMS), we can define the schema (or structure) of our documents and the database will ensure every document has the same structure.</p>
<p>In the schema, we would tell the database what to do if a document doesn&apos;t have a <em>profession</em> value. For instance, we could tell it to default to some value (<code>student</code>) or leave it <code>null</code>. We can also tell it what type it should be (eg - <code>integer</code> or <code>string</code>).</p>
<p>With a schema, our application can be certain that every document it retrieves from the database will have the same structure. There are pros and cons to using databases with and without schemas.</p>
<blockquote>
<p>One of the great benefits of these dynamic objects is that schema migrations become very easy. With a traditional RDBMS, releases of code might contain data migration scripts. Further, each release should have a reverse migration script in case a rollback is necessary. ALTER TABLE operations can be very slow and result in scheduled downtime.</p>
<p>With a schemaless database, 90% of the time adjustments to the database become transparent and automatic. For example, if we wish to add GPA to the student objects, we add the attribute, resave, and all is well &#x2013; if we look up an existing student and reference GPA, we just get back null. Further, if we roll back our code, the new GPA fields in the existing objects are unlikely to cause problems if our code was well written.</p>
</blockquote>
<h2 id="mongoose-schema">Mongoose Schema</h2>
<p>MongoDB is a schema-less database, which makes it easy to use without any configuration. But there is a benefit to having a <em>schema</em> at the Application level. For example, with a schema we can perform validation when we are saving data to the database.</p>
<p>At the moment, there is nothing stopping us from saving a <em>person</em> document like this:</p>
<pre class="language-"><code class="lang-js"><span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token string">&quot;Simon&quot;</span><span class="token punctuation">,</span>
    age<span class="token punctuation">:</span> <span class="token string">&quot;twenty three&quot;</span>
<span class="token punctuation">}</span>
</code></pre>
<blockquote>
<p>Group discussion: What problems might arise from entering the age as a <code>string</code> instead of an <code>integer</code>?</p>
</blockquote>
<p>Mongoose is a library that provides an easier interface to interact with MongoDB. It also helps us implement a Schema to provide <strong>validation</strong> to our database, so that we can make sure the data we are entering matches our expectations.</p>
<h2 id="exercise">Exercise</h2>
<p>Let&apos;s use Mongoose for the project we&apos;ve built so far.</p>
<ol>
<li><code>npm install --save mongoose</code></li>
<li>Add a Schema for our Models<ul>
<li>Create a file, <code>Post.js</code> under <code>/models/Post.js</code></li>
<li>Define the Schema for a post document in this file.</li>
</ul>
</li>
</ol>
<pre class="language-"><code class="lang-js"><span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;mongoose&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> Schema <span class="token punctuation">}</span> <span class="token operator">=</span> mongoose<span class="token punctuation">;</span>

<span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    title<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
    contents<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
    summary<span class="token punctuation">:</span> String
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> Post <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">&apos;posts&apos;</span><span class="token punctuation">,</span> schema<span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Post<span class="token punctuation">;</span>
</code></pre>
<ol>
<li>To use the Model in our application, require the <code>Post.js</code> schema file and <code>mongoose</code> at the top of your file:</li>
</ol>
<pre class="language-"><code class="lang-js">
<span class="token comment" spellcheck="true">// Top of your file</span>
<span class="token keyword">const</span> mongoConnection <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>MONGODB_URI <span class="token operator">||</span> <span class="token string">&apos;mongodb://localhost:27017/profile&apos;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;mongoose&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> Post <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;../models/Post&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<ol>
<li>Find the code where you connected to the database to retrieve the posts and change it to:</li>
</ol>
<pre class="language-"><code class="lang-js">mongoose<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>mongoConnection<span class="token punctuation">)</span><span class="token punctuation">;</span>
Post<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// callback is a function that takes an error as first argument and the posts as the second argument</span>
</code></pre>
<h1 id="form-data---post">Form Data - POST</h1>
<blockquote>
<p><strong>Discussion</strong>: What are the HTTP verbs? Which verbs are used to save data?</p>
</blockquote>
<p>Let&apos;s update the HTML form on our admin page to be able to save new Posts.</p>
<ol>
<li><p>Open the <code>admin.handlebars</code> file. Remove or comment the script at the end of the file:</p>
<pre class="language-"><code> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/js/posts-admin.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></li>
<li><p>Find the <code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span><span class="token punctuation">&gt;</span></span></code> tag. Add the <code>action</code> and <code>method</code> attributes. It should look like this:</p>
<pre class="language-"><code> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/save-post<span class="token punctuation">&quot;</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>POST<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>sentMessage<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>contactForm<span class="token punctuation">&quot;</span></span> <span class="token attr-name">novalidate</span><span class="token punctuation">&gt;</span></span>
</code></pre></li>
<li><p>We also need to add a <code>name</code> attribute to our form input fields. For example, the title will look like this:</p>
<pre class="language-"><code> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>title<span class="token punctuation">&quot;</span></span> <span class="token attr-name">...</span><span class="token punctuation">&gt;</span></span>
</code></pre><p> Add a <code>name</code> attribute to the <code>contents</code> and <code>summary</code> input fields.</p>
</li>
<li><p>Open the Developer tools. Try to save a Post and see what happens.</p>
<blockquote>
<p>Discussion: The browser is trying to perform a <code>POST</code> to <code>/save-post</code>. What HTTP status code is returned? What does it mean?</p>
</blockquote>
</li>
<li><p>Create the endpoint <code>/save-post</code> to handle this request.</p>
<p> We will use a package called <code>express-formidable</code> to handle the form requests. Let&apos;s start by installing it:</p>
<pre class="language-"><code> npm install --save express-formidable
</code></pre><p> Add these two lines to the top of the <code>siteController</code>:</p>
<pre class="language-"><code class="lang-js"> <span class="token keyword">const</span> formidable <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&apos;express-formidable&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 router<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">formidable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p> Then define the route:</p>
<pre class="language-"><code class="lang-js"> router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&apos;/save-post&apos;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>fields<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// contains non-file fields</span>
   <span class="token comment" spellcheck="true">// req.files will contain files (if you upload images for example)</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p> Now, if you save the form, our endpoint should log to the console an object containing the data you submitted.</p>
</li>
<li><p>Let&apos;s save the data to MongoDB. We will use our Mongoose <code>Post</code> model.</p>
<pre class="language-"><code class="lang-js"> <span class="token comment" spellcheck="true">// require the model in the top of the file</span>
 router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&apos;/save-post&apos;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>fields<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// contains non-file fields</span>
   <span class="token keyword">const</span> callback <span class="token operator">=</span> <span class="token punctuation">(</span>error<span class="token punctuation">,</span> post<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
       <span class="token comment" spellcheck="true">// handle any errors which might ocur</span>
       <span class="token keyword">if</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">&apos;/error&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>

       console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&apos;post saved successfully&apos;</span><span class="token punctuation">,</span> post<span class="token punctuation">)</span><span class="token punctuation">;</span>
       res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">&apos;/&apos;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   mongoose<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>mongoConnection<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment" spellcheck="true">// This is using the Model to create an object</span>
   <span class="token comment" spellcheck="true">// based on the fields submitted from the form</span>
   <span class="token keyword">const</span> newPost <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Post</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>fields<span class="token punctuation">)</span><span class="token punctuation">;</span>
   newPost<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</li>
</ol>
<h2 id="mongoose-validation">Mongoose Validation</h2>
<p>You can still save a Post without having any content, summary or title. Let&apos;s fix that:</p>
<h3 id="exercise-make-title-mandatory">Exercise: Make Title mandatory</h3>
<p>Update the Mongoose Model for Posts:</p>
<pre class="language-"><code class="lang-js"><span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    title<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        type<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
        required<span class="token punctuation">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    contents<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
    summary<span class="token punctuation">:</span> String
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Try to save a post without a title and look at what happens:</p>
<ul>
<li>What is the result?</li>
<li>How is the error handled? It redirects to <code>/error</code> if an error is returned (the first argument to the callback is an error)<ul>
<li>Happy Path</li>
</ul>
</li>
<li>Make the <code>contents</code> and <code>summary</code> fields required.</li>
</ul>
<h1 id="form-data---using-ajax">Form Data - Using AJAX</h1>
<p>Now let&apos;s go to <code>admin.handlebars</code> and uncomment or add the script at the end of file
<code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/js/posts-admin.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span></code></p>
<p>Open the Developer Tools and notice what happens.</p>
<ul>
<li>What is happening when you click on <code>Send</code>.</li>
</ul>
<p><strong>Exercise</strong>:</p>
<ul>
<li>Update your <code>POST /posts</code> endpoint in <code>apiController</code> to use Mongoose<ul>
<li>Don&apos;t forget to <em>require</em> the modules that you need</li>
</ul>
</li>
</ul>
<pre class="language-"><code class="lang-js">router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&apos;/posts&apos;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> callback <span class="token operator">=</span> <span class="token punctuation">(</span>error<span class="token punctuation">,</span> post<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">sendStatus</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&apos;post saved successfully&apos;</span><span class="token punctuation">,</span> post<span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>post<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  mongoose<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>mongoConnection<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">// we can access req.body because we&apos;re using body-parser middleware</span>
  <span class="token keyword">const</span> newPost <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Post</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
  newPost<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<ul>
<li>Notice how we&apos;re not rendering a view - we are just returning an HTTP response. <strong>Why is that</strong>?</li>
</ul>
<h2 id="note-on-progressive-enhancement">Note on Progressive Enhancement</h2>
<p>Go to Chrome Developer tools and Disable JavaScript. Does our <em>Save Post</em> functionality still work?</p>
<blockquote>
<p>Progressive Enhancement is a powerful methodology that allows Web developers to concentrate on building the best possible websites while balancing the issues inherent in those websites being accessed by multiple unknown user-agents. Progressive Enhancement (PE) is the principle of starting with a rock-solid foundation and then adding enhancements to it if you know certain visiting user-agents can handle the improved experience.</p>
</blockquote>
<h1 id="modelling-data">modelling Data</h1>
<p>What if we want to add a comments sections to our Posts.</p>
<ul>
<li>What are ways to model that data?</li>
<li>What if each Post has one Comment only</li>
<li>What if each Post has more than one Comment</li>
<li>What if we need to have more information about the comment (data added, and user)</li>
</ul>
<h2 id="embedded-documents">Embedded documents</h2>
<p>With MongoDB, you can take advantage of MongoDB rich documents to embed related data in a single structure or documents.
<img src="https://docs.mongodb.com/manual/_images/data-model-denormalized.bakedsvg.svg" alt=""></p>
<h2 id="referencing-documents">Referencing documents</h2>
<p>Another way of modelling data, is to use Reference documents.</p>
<p><img src="https://docs.mongodb.com/manual/_images/data-model-normalized.bakedsvg.svg" alt=""></p>
<blockquote>
<p>References provides more flexibility than embedding. However, client-side applications must issue follow-up queries to resolve the references. In other words, normalized data models can require more round trips to the server.</p>
</blockquote>
<p><strong>Discussion</strong>: What do you think are the advantages and disadvantages of the approach?</p>
<h2 id="reading">Reading</h2>
<p>Let&apos;s read this blog post together<a href="https://alexanderzeitler.com/articles/mongoose-referencing-schema-in-properties-and-arrays/" target="_blank">https://alexanderzeitler.com/articles/mongoose-referencing-schema-in-properties-and-arrays/</a></p>
<h2 id="exercise-data-modelling">Exercise: Data modelling</h2>
<p>Requirements: We&apos;re building a System for a Hospital. We want to keep track of Doctors and their Appointments with Patients. We need to have the basic information about the doctor (name, contact information and address), the patients (name, age, contact information). Each appointment will have a date, notes from the doctor and a list of prescriptions. A patient is assigned one doctor, and all the appointments will be with the same doctor. A doctor can have up to 20 patients.</p>
<ul>
<li>What collections do we need in our database</li>
<li>Write a document representing a Patient. How will it look like?</li>
<li>What will the other collections (if any) contain?</li>
<li>Stretch: What if each prescription has one or more Medicines and we want to keep information about the Medicine including its price.</li>
</ul>
<h2 id="exercise-adding-comments">Exercise: Adding comments</h2>
<p>In the <code>view single post</code> view, add this form</p>
<pre class="language-"><code class="lang-html"> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>POST<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>textarea</span> <span class="token attr-name">rows</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>5<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>comment<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>form-control<span class="token punctuation">&quot;</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>Contents<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>contents<span class="token punctuation">&quot;</span></span> <span class="token attr-name">required</span> <span class="token attr-name">data-validation-required-message</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>Please enter the contents of the blog post.<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>textarea</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>btn btn-default<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Add Comment<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<ul>
<li>Notice that the form does not an <code>action</code> attribute - what does that mean? Open the Developer tools and see what happens when you click the button</li>
</ul>
<p>Update the Post model to have an array of Comments</p>
<pre class="language-"><code class="lang-js">comments<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
    content<span class="token punctuation">:</span> String
<span class="token punctuation">}</span><span class="token punctuation">]</span>
</code></pre>
<p><strong>Exercise</strong>:</p>
<ul>
<li>Add a route that handles the data being sent by the Client and saves it to the database<ul>
<li>Use the technique using <code>findById</code> described in this <a href="http://mongoosejs.com/docs/documents.html" target="_blank">documentation entry</a></li>
<li>Also look at the documentation of $push to know how to add to an array <a href="https://docs.mongodb.com/manual/reference/operator/update/push/#up._S_push" target="_blank">https://docs.mongodb.com/manual/reference/operator/update/push/#up._S_push</a></li>
</ul>
</li>
<li>Are there more way we could have modeled our comments?</li>
</ul>
<h1 id="resources">Resources</h1>
<p>Why Schemaless - <a href="https://www.mongodb.com/blog/post/why-schemaless" target="_blank">https://www.mongodb.com/blog/post/why-schemaless</a>
Progressive Enhancement - <a href="https://www.smashingmagazine.com/2009/04/progressive-enhancement-what-it-is-and-how-to-use-it/" target="_blank">https://www.smashingmagazine.com/2009/04/progressive-enhancement-what-it-is-and-how-to-use-it/</a>
Mongoose CRUD - <a href="https://coursework.vschool.io/mongoose-crud/" target="_blank">https://coursework.vschool.io/mongoose-crud/</a></p>
<h1 id="homework">Homework</h1>
<p>Group project - <a href="https://github.com/CodeYourFuture/group-projects#expressmongodb-projects" target="_blank">https://github.com/CodeYourFuture/group-projects#expressmongodb-projects</a></p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="lesson4.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page: Week 15 - MongoDB">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Week 16","level":"1.6.5","depth":2,"next":{"title":"Week 17","level":"1.6.6","depth":2,"ref":"","articles":[]},"previous":{"title":"Week 15 - MongoDB","level":"1.6.4","depth":2,"path":"node-db/lesson4.md","ref":"node-db/lesson4.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["prism","-highlight"],"pluginsConfig":{"prism":{"css":["prismjs/themes/prism-tomorrow.css"]},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"node-db/lesson5.md","mtime":"2017-09-02T10:25:05.766Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2017-09-02T10:26:24.914Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

